name: Desktop Smoke

on:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  smoke-desktop:
    name: Smoke Desktop (${{ matrix.platform }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            platform: windows
          - os: macos-latest
            platform: macos
          - os: ubuntu-latest
            platform: linux
    env:
      CSC_IDENTITY_AUTO_DISCOVERY: "false"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v6
        with:
          node-version: 20

      - name: Install dependencies
        shell: bash
        run: |
          set -euo pipefail
          npm ci --prefix backend
          npm ci --prefix frontend

      - name: Bundle backend
        shell: bash
        run: |
          set -euo pipefail
          chmod +x frontend/scripts/bundle-backend.sh frontend/scripts/rebuild-native.sh || true
          ./frontend/scripts/bundle-backend.sh
          ./frontend/scripts/rebuild-native.sh

      - name: Set up embedded Python
        shell: bash
        run: |
          set -euo pipefail
          chmod +x frontend/scripts/setup-python.sh || true
          ./frontend/scripts/setup-python.sh

      - name: Build desktop app
        shell: bash
        run: |
          set -euo pipefail
          cd frontend
          npm run build:electron -- --publish never

      - name: Resolve desktop runtime ports
        id: runtime-ports
        shell: bash
        run: |
          set -euo pipefail
          prod_backend_port="$(node -p "const cfg=require('./frontend/electron/runtime-config.json'); cfg.ports.prodBackend")"
          if ! [[ "$prod_backend_port" =~ ^[0-9]+$ ]]; then
            echo "Invalid prod backend port: $prod_backend_port" >&2
            exit 1
          fi
          echo "prod_backend_port=$prod_backend_port" >> "$GITHUB_OUTPUT"

      - name: Install Linux display dependencies
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            xvfb libgtk-3-0 libxss1 libasound2t64 libgbm1 \
            libxcomposite1 libxdamage1 libxfixes3 libxrandr2 \
            libdrm2 libxkbcommon0

      - name: Smoke test Windows app
        if: matrix.platform == 'windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $backendPort = "${{ steps.runtime-ports.outputs.prod_backend_port }}"

          $portable = Get-ChildItem -Path "frontend/release" -Filter "*portable*.exe" -File |
            Sort-Object LastWriteTime -Descending |
            Select-Object -First 1

          if ($portable) {
            $exe = $portable
          } else {
            $exe = Get-ChildItem -Path "frontend/release/win-unpacked" -Filter "*.exe" -File |
              Where-Object { $_.Name -notmatch "elevate|uninstall" } |
              Sort-Object Length -Descending |
              Select-Object -First 1
          }

          if (-not $exe) {
            throw "No runnable executable found in frontend/release"
          }

          $log = Join-Path $env:RUNNER_TEMP "desktop-smoke-windows.log"
          $appProcName = [System.IO.Path]::GetFileNameWithoutExtension($exe.Name)
          $proc = Start-Process -FilePath $exe.FullName -PassThru -RedirectStandardOutput $log -RedirectStandardError $log
          $healthy = $false

          try {
            for ($i = 0; $i -lt 90; $i++) {
              Start-Sleep -Seconds 1
              try {
                $resp = Invoke-WebRequest -Uri "http://127.0.0.1:$backendPort/api/auth/status" -UseBasicParsing -TimeoutSec 2
                if ($resp.StatusCode -ge 200 -and $resp.StatusCode -lt 500) {
                  Write-Host "Backend health check passed (status $($resp.StatusCode))"

                  # Validate response is valid JSON
                  try {
                    $null = $resp.Content | ConvertFrom-Json
                    Write-Host "Response is valid JSON"
                  } catch {
                    throw "Backend returned non-JSON response body: $($resp.Content)"
                  }

                  $healthy = $true
                  break
                }
              } catch [System.Net.WebException] {
                # Keep polling until timeout.
              }
            }

            if (-not $healthy) {
              if (Test-Path $log) {
                Write-Host "=== App log tail ==="
                Get-Content $log -Tail 200
              }
              throw "Backend health endpoint did not respond in time."
            }

            # Verify the Electron process is still alive after health checks
            $stillRunning = Get-Process -Id $proc.Id -ErrorAction SilentlyContinue
            if (-not $stillRunning -or $proc.HasExited) {
              throw "Electron process exited unexpectedly after health checks (exit code: $($proc.ExitCode))."
            }
            Write-Host "Electron process is still running after health checks (PID $($proc.Id))"
          } finally {
            Get-Process -Name $appProcName -ErrorAction SilentlyContinue | Stop-Process -Force
            if ($proc -and -not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force
            }
          }

      - name: Smoke test macOS app
        if: matrix.platform == 'macos'
        shell: bash
        run: |
          set -euo pipefail
          backend_port="${{ steps.runtime-ports.outputs.prod_backend_port }}"

          APP_PATH="$(find frontend/release -maxdepth 2 -type d -name '*.app' | head -n 1)"
          if [[ -z "${APP_PATH}" ]]; then
            echo "No .app bundle found under frontend/release" >&2
            ls -la frontend/release || true
            exit 1
          fi

          BIN_PATH="$(find "$APP_PATH/Contents/MacOS" -mindepth 1 -maxdepth 1 -type f | head -n 1)"
          if [[ -z "${BIN_PATH}" ]]; then
            echo "No executable found in $APP_PATH/Contents/MacOS" >&2
            exit 1
          fi

          LOG_FILE="$RUNNER_TEMP/desktop-smoke-macos.log"
          "$BIN_PATH" >"$LOG_FILE" 2>&1 &
          APP_PID=$!
          healthy=0

          for _ in $(seq 1 90); do
            sleep 1

            if ! kill -0 "$APP_PID" 2>/dev/null; then
              echo "App process exited prematurely during startup." >&2
              break
            fi

            response="$(curl -sS --max-time 2 "http://127.0.0.1:${backend_port}/api/auth/status" 2>/dev/null)" || continue
            http_code="$(curl -so /dev/null -w '%{http_code}' --max-time 2 "http://127.0.0.1:${backend_port}/api/auth/status" 2>/dev/null)" || continue

            if [[ "$http_code" -ge 200 && "$http_code" -lt 500 ]]; then
              echo "Backend health check passed (HTTP ${http_code})"

              # Validate response is valid JSON
              if ! echo "$response" | python3 -m json.tool >/dev/null 2>&1; then
                echo "Backend returned non-JSON response body: $response" >&2
                kill "$APP_PID" 2>/dev/null || true
                wait "$APP_PID" 2>/dev/null || true
                exit 1
              fi
              echo "Response is valid JSON"

              healthy=1
              break
            fi
          done

          if [[ "$healthy" -ne 1 ]]; then
            echo "Backend health endpoint did not respond in time." >&2
            echo "=== App log tail ===" >&2
            tail -n 200 "$LOG_FILE" >&2 || true
            kill "$APP_PID" 2>/dev/null || true
            wait "$APP_PID" 2>/dev/null || true
            exit 1
          fi

          # Verify the Electron process is still alive after health checks
          if ! kill -0 "$APP_PID" 2>/dev/null; then
            echo "Electron process exited unexpectedly after health checks." >&2
            wait "$APP_PID"
            exit 1
          fi
          echo "Electron process is still running after health checks (PID $APP_PID)"

          kill "$APP_PID" 2>/dev/null || true
          wait "$APP_PID" 2>/dev/null || true

      - name: Smoke test Linux app
        if: matrix.platform == 'linux'
        shell: bash
        run: |
          set -euo pipefail
          backend_port="${{ steps.runtime-ports.outputs.prod_backend_port }}"

          # Start Xvfb for headless display
          Xvfb :99 -screen 0 1024x768x24 &
          XVFB_PID=$!
          export DISPLAY=:99
          sleep 1

          # Find the AppImage
          APP_IMAGE="$(find frontend/release -maxdepth 1 -name '*.AppImage' -type f | head -n 1)"
          if [[ -z "${APP_IMAGE}" ]]; then
            echo "No AppImage found under frontend/release" >&2
            ls -la frontend/release || true
            kill "$XVFB_PID" 2>/dev/null || true
            exit 1
          fi

          chmod +x "$APP_IMAGE"

          LOG_FILE="$RUNNER_TEMP/desktop-smoke-linux.log"
          "$APP_IMAGE" --no-sandbox --disable-gpu >"$LOG_FILE" 2>&1 &
          APP_PID=$!
          healthy=0

          for _ in $(seq 1 90); do
            sleep 1

            if ! kill -0 "$APP_PID" 2>/dev/null; then
              echo "App process exited prematurely during startup." >&2
              break
            fi

            response="$(curl -sS --max-time 2 "http://127.0.0.1:${backend_port}/api/auth/status" 2>/dev/null)" || continue
            http_code="$(curl -so /dev/null -w '%{http_code}' --max-time 2 "http://127.0.0.1:${backend_port}/api/auth/status" 2>/dev/null)" || continue

            if [[ "$http_code" -ge 200 && "$http_code" -lt 500 ]]; then
              echo "Backend health check passed (HTTP ${http_code})"

              # Validate response is valid JSON
              if ! echo "$response" | python3 -m json.tool >/dev/null 2>&1; then
                echo "Backend returned non-JSON response body: $response" >&2
                kill "$APP_PID" 2>/dev/null || true
                wait "$APP_PID" 2>/dev/null || true
                kill "$XVFB_PID" 2>/dev/null || true
                exit 1
              fi
              echo "Response is valid JSON"

              healthy=1
              break
            fi
          done

          if [[ "$healthy" -ne 1 ]]; then
            echo "Backend health endpoint did not respond in time." >&2
            echo "=== App log tail ===" >&2
            tail -n 200 "$LOG_FILE" >&2 || true
            kill "$APP_PID" 2>/dev/null || true
            wait "$APP_PID" 2>/dev/null || true
            kill "$XVFB_PID" 2>/dev/null || true
            exit 1
          fi

          # Verify the Electron process is still alive after health checks
          if ! kill -0 "$APP_PID" 2>/dev/null; then
            echo "Electron process exited unexpectedly after health checks." >&2
            wait "$APP_PID"
            kill "$XVFB_PID" 2>/dev/null || true
            exit 1
          fi
          echo "Electron process is still running after health checks (PID $APP_PID)"

          kill "$APP_PID" 2>/dev/null || true
          wait "$APP_PID" 2>/dev/null || true
          kill "$XVFB_PID" 2>/dev/null || true
